<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
  <meta charset="utf-8">
  <meta name="generator" content="quarto-0.9.178">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="国里愛彦（専修大学">
  <title>TWS-004「心理学研究における研究室インフラの整備」</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>

  <script src="doc-cloud-computing_files/libs/clipboard/clipboard.min.js"></script>
  <script src="doc-cloud-computing_files/libs/quarto-html/quarto.js"></script>
  <script src="doc-cloud-computing_files/libs/quarto-html/popper.min.js"></script>
  <script src="doc-cloud-computing_files/libs/quarto-html/tippy.umd.min.js"></script>
  <script src="doc-cloud-computing_files/libs/quarto-html/anchor.min.js"></script>
  <link href="doc-cloud-computing_files/libs/quarto-html/tippy.css" rel="stylesheet">
  <link id="quarto-text-highlighting-styles" href="doc-cloud-computing_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
  <script src="doc-cloud-computing_files/libs/bootstrap/bootstrap.min.js"></script>
  <link href="doc-cloud-computing_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
  <link href="doc-cloud-computing_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc">
<h2 id="toc-title">Table of contents</h2>
<ul>
<li><a href="#仮想マシンの準備" class="nav-link active" data-scroll-target="#仮想マシンの準備">仮想マシンの準備</a></li>
<li><a href="#インスタンスのポート設定" class="nav-link" data-scroll-target="#インスタンスのポート設定">インスタンスのポート設定</a></li>
<li><a href="#domainの入手とサブドメインの設定" class="nav-link" data-scroll-target="#domainの入手とサブドメインの設定">Domainの入手とサブドメインの設定</a></li>
<li><a href="#docker-desktopのインストール" class="nav-link" data-scroll-target="#docker-desktopのインストール">Docker-Desktopのインストール</a></li>
<li><a href="#traefikの準備" class="nav-link" data-scroll-target="#traefikの準備">Traefikの準備</a></li>
<li><a href="#rstudio-serverを用意する" class="nav-link" data-scroll-target="#rstudio-serverを用意する">RStudio serverを用意する</a></li>
<li><a href="#jupyterhubを用意する" class="nav-link" data-scroll-target="#jupyterhubを用意する">JupyterHubを用意する</a>
<ul class="collapse">
<li><a href="#jupyter-hubのユーザー追加と設定" class="nav-link" data-scroll-target="#jupyter-hubのユーザー追加と設定">Jupyter Hubのユーザー追加と設定</a></li>
</ul></li>
<li><a href="#jatosを用意する" class="nav-link" data-scroll-target="#jatosを用意する">JATOSを用意する</a></li>
<li><a href="#wordpressを用意する" class="nav-link" data-scroll-target="#wordpressを用意する">WordPressを用意する</a></li>
</ul>
</nav>
</div>
<main class="content" id="quarto-document-content">
<header id="title-block-header" class="quarto-title-block default">



<div class="quarto-title"><h1 class="title display-7">TWS-004「心理学研究における研究室インフラの整備」</h1><p class="subtitle lead">日本心理学会(2022年)</p></div><div class="quarto-title-meta"><div><div class="quarto-title-meta-heading">Author</div><div class="quarto-title-meta-contents"><div class="quarto-title-authors"><div><div>
<p>国里愛彦（専修大学</p>
</div></div></div></div></div></div></header>

<section id="仮想マシンの準備" class="level2">
<h2 class="anchored" data-anchor-id="仮想マシンの準備">仮想マシンの準備</h2>
<ul>
<li><p>Google Cloud Platform（GCP)，Amazon Web Services(AWS)，Microsoft Azure，「さくらインターネット」など，現状では様々なクラウドコンピューティングサービスがある。</p></li>
<li><p>国里は，Amazon Web Services(AWS)とMicrosoft Azureはほとんど使ったことがなく，過去２年半ほどGoogle Cloud Platform（GCP)を使い，今年は主に「さくらインターネット」をゼミでは使っている。</p></li>
<li><p>Google Cloud Platform（GCP)で困ることはなかったが，円安と月によって料金が返送するのが，ゼミのサーバーの利用法としてはちょっとやりにくかったので，今年度からは「さくらインターネット」にしている。</p></li>
<li><p>今回のTWSでは一時的にサーバーを立てる関係上，Google Cloud Platform（GCP)のe2-mediumで準備をしてみました。月間の利用料がでています。RStudio serverとJupyterHubなどで重い計算をせず，とりあえず試す分にはこれでもいけます。</p></li>
</ul>
<p><img src="pic/gce01.png" class="img-fluid"></p>
<p>実際にゼミで複数人が同時にアクセスする場合は，</p>
<p><img src="pic/gce02.png" class="img-fluid"></p>
<ul>
<li><p>これくらいならゼミ生が使っても問題がない。</p></li>
<li><p>E2は頼りないが安い。今回のデモでは，2-mediumを使う。</p></li>
<li><p>ブートディスクを「変更」する。</p></li>
<li><p>ファイヤーウォールの設定(「HTTP トラフィックを許可する」と「HTTPS トラフィックを許可する」にチェックをいれる)して，「作成」をクリックするとインスタンスが準備される</p></li>
<li><p>インスタンスができたら，SSHで接続する。</p></li>
</ul>
</section>
<section id="インスタンスのポート設定" class="level2">
<h2 class="anchored" data-anchor-id="インスタンスのポート設定">インスタンスのポート設定</h2>
<ul>
<li>GCPの「VPCネットワーク」→「ファイヤーウォールルール」で「ファイアウォール ルールの作成」を押して新しいSSHポートを設定します。名前やターゲットタグは好きな名前にしてください（私は適当に”ssh-allow-port”って名前にしています）。優先度は <code>1000</code> にして，トラフィックの方向は上り，一致した時のアクションは許可，ソースのIP範囲は，<code>0.0.0.0/0</code>とします。プロトコルは <code>tcp</code> でポートに好きなポート番号を入れます。<br>
</li>
<li>設定した新しいファイアウォールルールを適用するため，VMインスタンスをクリックして，「編集」ボタンを押して，ネットワークタグに上記で決めたターゲットタグを入れて保存します。<br>
</li>
<li>通常のSSH接続(22portを使用)をします（「Compute Engine」の「VMインスタンス」の当該VMインスタンスの右端にある「SSH」をクリックします）。<br>
</li>
<li>コンソールっぽい画面が出てきたら，以下のコマンドを打って，vimでsshdの設定ファイルを開きます。</li>
</ul>
<pre><code>sudo vim /etc/ssh/sshd_config</code></pre>
<ul>
<li>バンっと画面に文字が出てきてビビるかもしれませんが，落ち着いて， <code># Port 22</code> を探して， <code>i</code> をタイプします（文字が挿入できるようになります）。#をはずして，22の代わりに自分が使いたいポート番号を入れます( <code>Port 自分の使いたい番号</code> )。入力ができたら，escキーをタイプしてから， <code>:wq</code> とタイプします（保存されます）。<br>
</li>
<li>sshdの設定を反映させるために，以下のコマンドで再起動させます。</li>
</ul>
<pre><code>sudo systemctl restart sshd</code></pre>
<ul>
<li>ここで今22番portで開いた画面はそのままにして（閉じない），VMインスタンスの右端にある「SSH」の下矢印を押して，「ブラウザウィンドウでカスタムポートを開く」をクリックします。入力欄が出てくるので，そこに先程設定した新しいSSHのポートを入力して開きます。<br>
</li>
<li>新しいSSHのポートでも開けたら，22番portを閉じます。もう一度，「VPCネットワーク」→「ファイヤーウォールルール」で「ファイアウォール ルールの作成」を押します。名前やターゲットタグは好きな名前にしてください（私は適当に”disallow-ssh22”って名前にしています)。優先度は <code>1000</code> にして，トラフィックの方向は上り，一致した時のアクションは <code>拒否</code> ，ソースのIP範囲は，<code>0.0.0.0/0</code>とします。プロトコルは <code>tcp</code> でポートは <code>22</code> にします。<br>
</li>
<li>VMインスタンスをクリックして，「編集」を押し，ネットワークタグに上記で決めたターゲットタグを入れて保存します(これで，httpのタグ，httpsのタグ，新しいsshポートのタグ，22番ポートを閉じるタグの４つがあると思います)。<br>
</li>
<li>通常のSSH接続(22番ポート)をしても接続できず，「ブラウザウィンドウでカスタムポートを開く」で自分で設定したSSHポートを使って接続できたら成功です。<br>
</li>
<li>ちなみに，SSH接続後に以下を入力するとアクセス状況を見れます（ <code>f</code> で次の画面に進んで， <code>q</code> で閉じます）。</li>
</ul>
<pre><code>sudo less /var/log/auth.log</code></pre>
</section>
<section id="domainの入手とサブドメインの設定" class="level1">
<h1>Domainの入手とサブドメインの設定</h1>
<ul>
<li>Googleドメインなどのサービスを使って好きなドメイン名を入手する<br>
</li>
<li></li>
</ul>
</section>
<section id="docker-desktopのインストール" class="level1">
<h1>Docker-Desktopのインストール</h1>
<ul>
<li><a href="https://docs.docker.com/engine/install/ubuntu/">Docker社のドキュメント</a>に従ってインストールする。<br>
</li>
<li>必要なソフトのインストール</li>
</ul>
<pre><code>sudo apt-get update
sudo apt-get install ca-certificates curl gnupg lsb-release</code></pre>
<ul>
<li></li>
<li>GPGキーの追加とリポジトリの用意<br>
</li>
<li></li>
</ul>
<pre><code>sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</code></pre>
<ul>
<li>Docker Engineのインストール</li>
</ul>
<pre><code>sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin</code></pre>
</section>
<section id="traefikの準備" class="level1">
<h1>Traefikの準備</h1>
<ul>
<li>TraefikのBASIC認証で使うhtpasswdを使えるようにする。</li>
</ul>
<p>https://zenn.dev/pitekusu/books/traefik-pitekusu</p>
<pre><code>sudo apt install apache2-utils</code></pre>
<ul>
<li>ユーザー名とパスワードを変更して実行</li>
</ul>
<pre><code>htpasswd -nb ユーザー名 パスワード</code></pre>
<ul>
<li>ネットワークの準備をする</li>
</ul>
<pre><code>sudo docker network create traefik-network</code></pre>
<ul>
<li>Traefikの作業フォルダを作ります</li>
</ul>
<pre><code>mkdir traefik
cd traefik</code></pre>
<ul>
<li>以下を実行して，traefik.ymlを用意する</li>
</ul>
<pre class="　"><code>sudo vim traefik.yml</code></pre>
<ul>
<li>「メールアドレス@example.com」は自分のアドレスに変えてコピペ，「Esc」を押して，「:wq」をタイプすることで保存して閉じる</li>
</ul>
<pre><code>entryPoints:
  web:
    address: :80
    http:
      redirections:
        entryPoint:
          to: websecure
          scheme: https
  websecure:
    address: :443
api:
  insecure: false
  dashboard: true

providers:
  docker:
    exposedByDefault: false

certificatesresolvers:
  myresolver:
    acme:
      httpChallenge:
        entryPoint: web
      email: "メールアドレス@example.com"
      storage: "/letsencrypt/acme_myresolver.json"

log:
  filePath: "/logs/traefik.log"
  format: json
  level: INFO

accessLog:
  filePath: "/logs/access.log"
  format: json</code></pre>
<ul>
<li>以下を実行して，compose.yml を用意する</li>
</ul>
<pre class="　"><code>sudo vim compose.yml</code></pre>
<ul>
<li>your.domainは自分の使っているドメインにしてコピペ，「アカウント名とハッシュ値を貼り付け」もコピオペする（その際に， <span class="math inline">\(は全て\)</span> $にしないと動かない落とし穴があるので注意する）。「Esc」を押して，「:wq」をタイプすることで保存して閉じる</li>
</ul>
<pre><code>services:
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: always
    ports:
      - "80:80"
      - "443:443"
    networks:
      - traefik-network
    environment:
      TZ: Asia/Tokyo
    labels:
      traefik.enable: true
      traefik.http.routers.dashboard.rule: Host(`traefik.your.domain`)
      traefik.http.routers.dashboard.entrypoints: websecure
      traefik.http.routers.dashboard.tls.certresolver: myresolver
      traefik.http.routers.dashboard.service: api@internal
      traefik.http.routers.dashboard.middlewares: auth
      traefik.http.middlewares.auth.basicauth.users: アカウント名とハッシュ値を貼り付け
    volumes:
      - letsencrypt_data:/letsencrypt 
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
      - /var/log:/logs
volumes:
  letsencrypt_data:

networks:
  traefik-network:
    external: true</code></pre>
<ul>
<li>compose.ymlしたがって実行する。</li>
</ul>
<pre><code>sudo docker compose up -d</code></pre>
<ul>
<li><p>traefik.your.domainにアクセスすると，アカウント認証があるが，設定したものを入力して，以下のようなダッシュボードがでてきたら，成功している。</p></li>
<li><p>一度ホームディレクトリに戻る</p></li>
</ul>
<pre><code>cd ..</code></pre>
</section>
<section id="rstudio-serverを用意する" class="level1">
<h1>RStudio serverを用意する</h1>
<ul>
<li>まず，ホームディレクトリ内にrstudio_composeディレクトリを作って，そちらに移動し，compose.ymlを作ります。</li>
</ul>
<pre><code>sudo mkdir rstudio_compose
cd rstudio_compose
sudo vim compose.yml</code></pre>
<p>vimで開いたdocker-compose.ymlに，以下を変更したその下のコードを貼り付けてください。改変した内容をコピペできたら，escキーをタイプして， <code>:wq</code> とタイプします（保存されます）。<br>
- 「your.domain」のドメイン名を自分のものに変更する。<br>
- rstudioのユーザーIDとパスワードを変更する。<br>
- volumesの左側の./rstudioは，.のところをGCP上でpwdをした時にでてくるカレントディレクトにする必要があるかもしれません。<br>
-</p>
<pre><code>services:
  rstudio:
    image: ykunisato/paper-r:latest
    container_name: rstudio
    networks:
      - traefik-network
    container_name: rstudio
    restart: always
    environment:
      - USER=ユーザー名
      - PASSWORD=パスワード
    volumes:
      - ./rstudio:/home/rstudio
    labels:
      traefik.enable: true
      traefik.http.routers.rstudio.rule: Host(`rstudio.your.domain`)
      traefik.http.routers.rstudio.entrypoints: websecure
      traefik.http.routers.rstudio.tls.certresolver: myresolver

networks:
  traefik-network:
    external: true</code></pre>
<p>以下を実行して，用意したコンテナを起動します。イメージのダウンロードなどにしばらく時間がかかります。doneとでてきたら，終了です。</p>
<ul>
<li>compose.ymlしたがって実行する。</li>
</ul>
<pre><code>sudo docker compose up -d</code></pre>
<ul>
<li>rstudio.your.domainにアクセスして，RStudioのログイン画面が出てきたら，一度ホーム画面に戻る</li>
</ul>
<pre><code>cd ..</code></pre>
</section>
<section id="jupyterhubを用意する" class="level1">
<h1>JupyterHubを用意する</h1>
<ul>
<li>まず，ホームディレクトリ内にjupyterhub_composeディレクトリを作って，そちらに移動し，compose.ymlを作ります。</li>
</ul>
<pre><code>mkdir jupyterhub_compose
cd jupyterhub_compose
sudo vi compose.yml</code></pre>
<p>以下をコピペして，:wqする。</p>
<pre><code>services:
  jupyterhub:
    image: ykunisato/ccp-lab-hub
    container_name: jupyterhub
    networks:
      - traefik-network
    restart: always
    volumes:
      - /home/ubuntu/jupyterhub:/home
    labels:
      traefik.enable: true
      traefik.http.routers.jupyterhub.rule: Host(`jupyterhub.your.domain`)
      traefik.http.routers.jupyterhub.entrypoints: websecure
      traefik.http.routers.jupyterhub.tls.certresolver: myresolver

networks:
  traefik-network:
    external: true</code></pre>
<section id="jupyter-hubのユーザー追加と設定" class="level2">
<h2 class="anchored" data-anchor-id="jupyter-hubのユーザー追加と設定">Jupyter Hubのユーザー追加と設定</h2>
<ul>
<li>コンテナ内に入ってユーザーを追加する(XXXはユーザー名，途中でパスワード聞かれる)。</li>
</ul>
<pre><code>sudo docker exec -it jupyterhub bash
adduser XXX</code></pre>
<p>作成したアカウントをsuにして，juliaを起動する。</p>
<pre><code>su XXX
julia</code></pre>
<p>以下をコピペして，juliaを設定する。</p>
<pre><code>ENV["PYTHON"] = "";using Pkg;Pkg.update(); Pkg.add(["IJulia","PyCall"]); Pkg.build(["IJulia","PyCall"]); Pkg.add(["DataFrames","PyPlot","Distributions","Statistics","JuliaFormatter","CPUTime","Gadfly","GLM","Optim","Plots","Query","RDatasets","SpecialFunctions","StatisticalRethinking","StatsBase","StatsFuns","StatsPlots","AdvancedHMC","BAT","Bijectors","CmdStan","DiffEqBayes","DistributionsAD","ForwardDiff","MCMCChains","MeasureTheory","ParameterizedFunctions","Turing","LinearAlgebra","DifferentialEquations","Roots","SymPy","ForneyLab"]);Pkg.precompile()</code></pre>
<ul>
<li>compose.ymlしたがって実行する。</li>
</ul>
<pre><code>sudo docker compose up -d</code></pre>
<ul>
<li>jupyterhub.your.domainにアクセスして，jupyterのログイン画面が出てきたら，一度ホーム画面に戻る</li>
</ul>
<pre><code>cd ..</code></pre>
</section>
</section>
<section id="jatosを用意する" class="level1">
<h1>JATOSを用意する</h1>
<ul>
<li>まず，ホームディレクトリ内にjatos_composeディレクトリを作って，そちらに移動し，compose.ymlを作ります。</li>
</ul>
<pre><code>sudo mkdir jatos_compose
cd jatos_compose
sudo vi compose.yml</code></pre>
<p>jatos.your.domainを変更して，以下をコピペして，:wqする。</p>
<pre><code>services:
  jatos:
    image: jatos/jatos:latest
    container_name: jatos
    networks:
      - traefik-network
    restart: always
    labels:
      traefik.enable: true
      traefik.http.routers.jatos.rule: Host(`jatos.your.domain`)
      traefik.http.routers.jatos.entrypoints: websecure
      traefik.http.routers.jatos.tls.certresolver: myresolver

networks:
  traefik-network:
    external: true</code></pre>
<ul>
<li>compose.ymlしたがって実行する。</li>
</ul>
<pre><code>sudo docker compose up -d</code></pre>
<p>JATOSは立ち上がったらすぐに，admin/adminでログインして，アドミンのパスワードを変更する。</p>
<ul>
<li>ログインして，アドミンのパスワードが設定できたら，一度ホーム画面に戻る</li>
</ul>
<pre><code>cd ..</code></pre>
</section>
<section id="wordpressを用意する" class="level1">
<h1>WordPressを用意する</h1>
<ul>
<li>まず，ホームディレクトリ内にwordpress_composeディレクトリを作って，そちらに移動し，compose.ymlを作ります。</li>
</ul>
<pre><code>sudo mkdir wordpress_compose
cd wordpress_compose
sudo vi compose.yml</code></pre>
<p>wordpress.your.domainを変更して，ルートのパスワードとDBのパスワードを設定してコピペして，:wqする。</p>
<pre><code>services:
  db:
    image: mysql:5.7
    container_name: wp-db
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - default
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ルートのパスワード
      MYSQL_DATABASE: wordpress
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: DBのパスワード

  wordpress:
    depends_on:
      - db
    image: wordpress:latest
    container_name: wordpress
    networks:
      - traefik-network
      - default
    restart: always
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_USER: wordpress
      WORDPRESS_DB_PASSWORD: DBのパスワード
    labels:
      traefik.enable: true
      traefik.http.routers.wordpress.rule: Host(`wordpress.your.domain`)
      traefik.http.routers.wordpress.entrypoints: websecure
      traefik.http.routers.wordpress.tls.certresolver: myresolver

volumes:
    db_data:

networks:
  traefik-network:
    external: true</code></pre>
<ul>
<li>compose.ymlしたがって実行する。</li>
</ul>
<pre><code>sudo docker compose up -d</code></pre>
<ul>
<li>WordPressが立ち上がったのを確認したら，WordPressのインストールとアドミンアカウントの設定を行う。一度ホームに戻る</li>
</ul>
<pre><code>cd ..</code></pre>
<ul>
<li>プラグインのSensei-LMSをインストールして，有効化する。</li>
</ul>

</section>
</main>
<!-- /main column -->
<script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    setTimeout(function() {
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->


</body></html>