<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Docker入門</title>
    <meta charset="utf-8" />
    <meta name="author" content="国里愛彦(専修大学)" />
    <script src="libs/header-attrs-2.10/header-attrs.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Docker入門
### 国里愛彦(専修大学)
### 2021年9月13日

---




class: center, middle

# .big3[なぜDocker？]

---
# .big1[再現性がヤバいから！]

- 方法の再現可能性（同じデータに同じ解析方法で同じ結果を得られること）が難しい。
- OSやソフトのバージョンが違うと再現できないことがある。
- OSやソフトのバージョンが分かっても，それを揃えるのが困難(論文にWindows XP, SPSS ver12と書いてあって，その環境用意できる？)。

→.big1[Dockerで解決！]

---
# .big1[忙しいから！]

- 院生の頃は時間がたくさんあって，研究室や自分のパソコンも色々とこだわった設定をしていた（楽しかった）
- 就職＆家族ができて，時間がまったくない（学期中は，院生時と比べて10%以下）
- RやStanやLaTeXのためにかける時間が惜しい・・・・
- ゼミのパソコンや学生が使う解析環境の整備の時間がない・・・めんどくさい・・・Windowsキライ・・・

→.big1[Dockerで解決！]
---

class: center, middle

# .big3[Docker入門]
---
# .big1[Dockerとは？]

- OSに依存せずに，Linuxベースのアプリケーションをコンテナ化する技術
- Dockerを使うとOSとソフトをまとめたコンテナをイメージとして配布可能

→Dockerを使えば再現可能な環境構築と共有が可能!

---
# まあ，こういうこと

&lt;img src="fig/docker.png" width="800"&gt;

---
# .big1[Rockerとは？]

- [Rocker](https://hub.docker.com/u/rocker)は， [Carl Boettiger](https://twitter.com/cboettig)と[Dirk Eddelbuettel](https://twitter.com/eddelbuettel)が始めた，R環境のためのDockerコンテナの作成・メンテナンスプロジェクト
- 他にもR用のDockerイメージは配布されているが，メンテナンスがしっかりしていて，issuesなども活発なので，Rockerがオススメ。
- RockerのGitHubリポジトリ：https://github.com/rocker-org/rocker-versioned

---
# Rockerの種類

- r-ver(RのRocker)
- rstudio(上にRStudioを追加)
- tidyverse(上にtidyverse &amp; devtoolsを追加)
- verse(上にTeXやRMarkdown系を追加)
- geospatial(上にgeospatialライブラリを追加)

→　**r-verは，debian:stableの上に構築されている**。つまり，Linuxの一種のDebianがベースになっているので，R外のソフトをいれる場合にDebianでググれば良い。

→　上から下にパッケージなどが追加されていっている。

---
# .big1[Paper-rとは？]

- rocker/verseをベースにして，心理学などで使うRパッケージを追加していったDockerイメージ
- 国里による国里のためのイメージなので，国里にとって便利なように設定されている。
- RMarkdownでの日本語PDFに必要なソフトやRStanやcmdstanrなどのちょっとインストールが面倒なものが入っているので，イメージを起動したら即仕事ができる。大体入っているので，追加インストールする必要があまりない。
- 色々と欲張り過ぎて，容量が大きいのがデメリット。

---
# WindowsへのDockerとPaper-rの導入

.big1[https://ykunisato.github.io/jpa2021-tws-jpaRmd/03.html]


# MacへのDockerとPaper-rの導入

.big1[https://ykunisato.github.io/jpa2021-tws-jpaRmd/04.html]

---
# M1 Macは未対応！

- Apple Silicon(M1 Mac)では，ARM64アーキテクチャーになった。
- 基本的には，従来のIntel x86_64のソフトが動き，R自体はARM64に対応している。
- 2021年8月の段階では，ARM64でネイティブに動くRStudioがないのと，ARM64ベースのRパッケージの管理システムないので，現状ではまだちゃんと動くR用のDockerがありません
- 実は個人開発で動くものもあるのですが，一番シェアのあるRockerからのリリースを待つのが良いかと思います。

---
# よく使うDockerコマンド(1)
## Dockerhubからイメージをプルして実行

- Mac
```
docker run -e PASSWORD=password -e DISABLE_AUTH=true -p 8787:8787 -v $(pwd):/home/rstudio -d --name name_of_container ykunisato/paper-r
```

- Windows
```
docker run -e PASSWORD=password -p 8787:8787 -v "%cd%":/home/rstudio -d --name name_of_container ykunisato/paper-r
```
---
# よく使うDockerコマンド(2)
- コンテナの確認: STATUSがUpになっているとコンテナが動いている

```
docker ps -a
```

- コンテナの起動: コンテナ停止時(STATUSがExited)に起動する

```
docker start コンテナ名
```
---
# よく使うDockerコマンド(3)
コンテナが不要になったら，コンテナの停止と削除をします。

- コンテナの停止
```
docker stop コンテナ名
```
- コンテナの削除
```
docker rm コンテナ名
```
---
# よく使うDockerコマンド(4)
コンテナを削除してもイメージは残るので，不要ならイメージも削除します。

- 削除するコンテナのIMAGE IDの確認
```
docker images
```
- IMAGE IDで指定したイメージの削除
```
docker rmi IMAGE_ID
```
---
class: center, middle

# .big3[オリジナルDocker入門]
---
# .big2[そろそろ...]

--
# .big2[マイDocker作りたくなってきたんじゃないかな？]

---
# .big1[時代とともに聞かなくなってきた...]
--

# .big2[「無いなら作る」].big1[のベイズ塾スピリットを発揮しよう！]

---
# Paper-rにRパッケージを追加したマイDockerを作ろう！

- 以下のGitHubリポジトリにDockerの設定ファイルが置いてある。

https://github.com/ykunisato/paper-r

- リポジトリからローカルにダウンロードしてください(Codeってところをいじるとできる)。
- 必要なのは，Dockerfileとinstall_r.rです。

---
# Dockerfile

- Dockerfileは，Dockerイメージの設計図(Debianベースなので，各種ソフトのインストールはLinuxでググる)

```
FROM rocker/verse:latest
LABEL maintainer="Yoshihiko Kunisato &lt;kunisato@psy.senshu-u.ac.jp&gt;"

# Install ipaexfont
RUN apt-get update
&lt;R外で必要なソフトのインストール（省略）&gt;
# install R packages
COPY install_r.r install_r.r
RUN ["r", "install_r.r"]
```
---
# Dockerfile

- Rパッケージは，Dockerfileに書くとLinuxコマンドが面倒なので，install_r.rで指定している

```
FROM rocker/verse:latest
LABEL maintainer="Yoshihiko Kunisato &lt;kunisato@psy.senshu-u.ac.jp&gt;"

# Install ipaexfont
RUN apt-get update
&lt;R外で必要なソフトのインストール（省略）&gt;
# install R packages
COPY install_r.r install_r.r
RUN ["r", "install_r.r"]
```
---
install_r.rの内容

```
install.packages("rstan", type = "source")
&lt;個別インストール必要なパッケージを先に，以下略&gt;

# install R packages from CRAN
install.packages(c("memisc",
＜省略＞
"rjson"
), error = TRUE, dependencies = TRUE)

# install R packages from GitHub
remotes::install_github(c("crsh/papaja",
＜省略＞
"ltl-manabi/olp"), dependencies = TRUE)
```

---
# .big1[ベイズ塾だから，全員ベイジアン]

--

# .big1[bayesianパッケージをpaper-rに追加しよう！]

---

# .big1[ついてこれるかな...]

--

- install.rに"bayesian"を加筆ください。

```
# install R packages from CRAN
install.packages(c("memisc",
"bayesian",
"imager",
&lt;省略&gt;
```

- お疲れさまでした！
---
# dockerイメージをビルドしてみよう！

- Dockerfileは設計図なので，それを元にイメージをビルドしてみる（これが結構コケることがあります）。
- ターミナルやコマンドプロンプトで先程のDockerfileとinstall_r.rのおいてあるフォルダに移動して，以下を実行します。名前は好きなものに変更ください。

```
docker build ./ -t 好きなマイイメージ名
```
---

ビルドにはすんごい時間がかかるので，MCMCと同じく放置しておこう！

&lt;img src="fig/docker_build.png" width="900"&gt;

---
# ビルドしたイメージは利用・配布できる

- ビルドしたイメージをrunしてみよう！library()で呼び出すと，bayesianが！

```
docker run -e PASSWORD=password ＜省略＞ マイイメージ名
```

- paper-r, rockerで気に食わないところがある，欲しい機能がない... .big1[**「無いなら作ろう！」**]

- Docker Hubを使えばイメージを共有することもできる。
---
# Docker Hubでの公開

- Docker Hubで公開すると，自分が使う場合にも便利だし，他の研究者にとっても役に立つので嬉しい。

&lt;img src="fig/docker_hub.png" width="750"&gt;

- Docker Hubで公開する際には，GitHubリポジトリにDockerfileをおいて，GitHubに変更が加わるとDocker Hub上でビルドできるように設定できる。

---
class: center, middle

# .big3[Dockerの活用]
---
# ゼミで使うRStudioサーバーでの活用

- 国里ゼミでは，ゼミでの演習や卒論・修論執筆をRStudioサーバー上で行っている。
- Google Compute Engine上にRStudioサーバーを設置するのは結構面倒くさい（特にSSL暗号化通信とか設定がめちゃくちゃ面倒くさい）。
- ゼミ用のDockerイメージと複数のDockerイメージを連携させるDocker-composeの設定をしておくと，サーバー設置にかかる時間の短縮と設定ミスが低減する。
- RStudio, Jupyter, JATOSなどを一気に簡単に設定できる。
- 詳細は，https://kunisatolab.github.io/main/how-to-rstudio-gce-https.html
---
# クラウドコンピューティング
- MCMCなど重めの解析をする場合，性能の高いワークステーションを買うことが多い。ただ，購入費用の割に使ってない時間も多い。また，経年変化も激しい.med[（あんなに高かったMacbook Proと安めのM1 Macbook Airが同等の性能とか・・・）]
- Dockerがあれば，解析のために一時的に複数のサーバーを立てることも簡単。コアも増やすことができるのでJobで工夫したり，複数のサーバーを立てて計算させて，計算が終わったら止めることもできる。
- 高いワークステーションよりも低コストで解析ができる.med[（クラスターコンピューティングが可能なケースではワークステーションよりも解析は早い）]



    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
